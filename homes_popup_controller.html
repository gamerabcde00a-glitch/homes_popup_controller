
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HOMES Popup Controller (Standalone)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    .info-container {
      background-color: #f5f5f5; padding: 16px; border-radius: 6px; margin-bottom: 16px;
    }
    .row { margin: 8px 0; }
    .row label { display: inline-block; width: 120px; }
    input[type="text"] { width: 480px; padding: 6px; }
    button { padding: 6px 10px; margin-right: 8px; }
    #armedState { margin-left: 8px; color: #0b5cab; }
    #log { font-size: 13px; color: #333; margin-top: 10px; }
    #log p { margin: 4px 0; }
    #log .dim { color: #666; }
    .muted { color: #666; }
  </style>
</head>
<body>
  <div class="info-container" id="statusBox">
    <div class="row"><strong>Status:</strong> HOMES Popup Controller (Standalone, no Genesys)</div>

    <!-- CRM URL input (you can lock this down and hide the input if preferred) -->
    <div class="row">
      <label for="crmUrl">CRM URL</label>
      <input id="crmUrl" type="text" placeholder="https://crm.example.com/" />
    </div>

    <!-- Controls -->
    <div class="row">
      <button id="armPopBtn" type="button">Enable CRM pop</button>
      <span id="armedState" class="muted"></span>
    </div>

    <div class="row">
      <button id="openCrmBtn" type="button">Open CRM</button>
      <button id="closeCrmBtn" type="button">Close CRM</button>
    </div>

    <div id="log"></div>
  </div>

  <script>
    const VERSION = '2.0.0 (Standalone, no Genesys, no param passing)';

    let crmTab = null;
    let preArmedWindow = null;

    const el = {
      statusBox: document.getElementById('statusBox'),
      crmUrl: document.getElementById('crmUrl'),
      armPopBtn: document.getElementById('armPopBtn'),
      openCrmBtn: document.getElementById('openCrmBtn'),
      closeCrmBtn: document.getElementById('closeCrmBtn'),
      armedState: document.getElementById('armedState'),
      log: document.getElementById('log')
    };

    function updateStatus(message, dim = false) {
      const p = document.createElement('p');
      p.textContent = message;
      if (dim) p.classList.add('dim');
      el.log.appendChild(p);

      // For diagnostics, show userActivation state if available
      try {
        if (navigator.userActivation) {
          const ua = navigator.userActivation;
          const diag = document.createElement('p');
          diag.classList.add('dim');
          diag.textContent = `userActivation: isActive=${ua.isActive} hasBeenActive=${ua.hasBeenActive}`;
          el.log.appendChild(diag);
        }
      } catch {}
    }

    function setArmedState(msg) {
      el.armedState.textContent = msg || '';
    }

    function normaliseUrl(u) {
      // If user entered a bare host, try to make it a valid URL
      try {
        return new URL(u).toString();
      } catch {
        // If no scheme, try https://
        try {
          return new URL('https://' + u).toString();
        } catch {
          return null;
        }
      }
    }

    // Optionally allow ?crmUrl=... to prefill the field (no params are forwarded to the CRM tab)
    (function prefillFromQuery() {
      try {
        const params = new URLSearchParams(window.location.search);
        const qUrl = params.get('crmUrl');
        if (qUrl) el.crmUrl.value = qUrl;
      } catch {}
    })();

    // --- Arm button: open about:blank synchronously to capture user gesture ---
    el.armPopBtn.addEventListener('click', () => {
      preArmedWindow = window.open('', '_blank'); // synchronous, carries user activation
      if (preArmedWindow) {
        preArmedWindow.document.write('<p style="font-family:sans-serif">HOMES/CRM will open here…</p>');
        setArmedState('Armed ✔ — ready to open CRM');
        updateStatus('Pre-armed blank tab opened with user activation.');
      } else {
        setArmedState('Popup blocked — enable popups and click again');
        updateStatus('Popup was blocked by the browser.');
      }
    });

    // --- Open CRM (uses pre-armed tab if available) ---
    el.openCrmBtn.addEventListener('click', () => {
      const rawUrl = el.crmUrl.value.trim();
      const target = normaliseUrl(rawUrl);

      if (!rawUrl) {
        updateStatus('Please enter a CRM URL before opening.');
        el.crmUrl.focus();
        return;
      }
      if (!target) {
        updateStatus(`Invalid URL: "${rawUrl}". Try including scheme, e.g., https://example.com`);
        el.crmUrl.focus();
        return;
      }

      // Prefer the pre-armed tab (best compatibility)
      if (preArmedWindow && !preArmedWindow.closed) {
        preArmedWindow.location.href = target; // NOTE: no parameters are added
        crmTab = preArmedWindow;
        preArmedWindow = null;
        setArmedState('Opened ✔');
        updateStatus(`Navigated armed tab to: ${target}`);
        try { crmTab.opener = null; } catch {}
        return;
      }

      // Fallback: attempt to open directly (may be blocked)
      const opened = window.open(target, '_blank'); // NOTE: no parameters are added
      if (opened) {
        crmTab = opened;
        updateStatus('Opened CRM tab (no pre-arming).');
        setArmedState('Opened ✔');
        try { crmTab.opener = null; } catch {}
      } else {
        setArmedState('Popup blocked — click "Enable CRM pop" first');
        updateStatus('Popup blocked. Click "Enable CRM pop" then click "Open CRM".');
      }
    });

    // --- Close CRM ---
    el.closeCrmBtn.addEventListener('click', () => {
      if (crmTab && !crmTab.closed) {
        crmTab.close();
        updateStatus('CRM tab closed on request.');
      } else {
        updateStatus('No CRM tab to close.', true);
      }
      crmTab = null;
      setArmedState('');
    });

    // Initial banner
    updateStatus(`HOMES Popup Controller ${VERSION}`);
    updateStatus('Genesys integrations removed. No data is passed to the CRM page.');
  </script>
</body>
</html>
